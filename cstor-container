#!/bin/bash
set -e

rm -rvf zfs
rm -rvf spl

ZFS_MASTER="zfs-0.7-release"
SPL_STABLE_TAG="spl-0.7.9"

if [ ! -z "${GITHUB_USER_NAME}" ] && [ ! -z "${GITHUB_API_KEY}" ] && [ ! -z "${TRAVIS_TAG}" ];
then
    git clone https://${GITHUB_USER_NAME}:${GITHUB_API_KEY}@github.com/openebs/zfs zfs
    git clone https://${GITHUB_USER_NAME}:${GITHUB_API_KEY}@github.com/openebs/spl spl

    echo "Clone Completed"
    echo "tagging zfs and spl for ${TRAVIS_TAG} release"

    cd spl
    git checkout ${SPL_STABLE_TAG}
    git tag ${TRAVIS_TAG}
    git push origin ${TRAVIS_TAG}
    echo "pushed the tag: ${TRAVIS_TAG} to spl repository"

    cd ../zfs
    git checkout ${ZFS_MASTER}
    git tag ${TRAVIS_TAG}
    git push origin ${TRAVIS_TAG}
    echo "pushed the tag: ${TRAVIS_TAG} to zfs repository"
    cd ..
else
    git clone https://github.com/openebs/zfs
    git clone https://github.com/openebs/spl

    echo "Clone Completed"
fi;

cd spl
if [ ! -z "${TRAVIS_TAG}" ];
then
    git checkout ${TRAVIS_TAG}
else
    # Note: Currently there is no change in the spl code base
    # always use the upstream stable tag
    git checkout ${SPL_STABLE_TAG}
fi;
sh autogen.sh
./configure
make

cd ../zfs
#Checkout the correct zfs code base for compilation
# - Release Tag
# - Master branch  - will use active dev branch (zfs-0.7-release)
# - Non-master branch - checkout with branch name or 
#   will fallback to active dev branch
if [ ! -z "${TRAVIS_TAG}" ];
then
    echo "checkout code from release tag: ${TRAVIS_TAG}"
    git checkout ${TRAVIS_TAG}
elif [ ! -z "${TRAVIS_BRANCH}" ];
then
    if [ $TRAVIS_BRANCH = "master" ];
    then
        echo "checkout code from branch: ${ZFS_MASTER}"
        git checkout ${ZFS_MASTER}
    else
        echo "checkout code from branch: ${TRAVIS_BRANCH}"
        git checkout ${TRAVIS_BRANCH}
        rc=$?; if [ $rc -ne 0 ]; then git checkout ${ZFS_MASTER}; exit; fi
    fi;
fi;

sh autogen.sh
./configure --enable-uzfs=yes --with-config=user --with-jemalloc
make

echo "Build Complete";
